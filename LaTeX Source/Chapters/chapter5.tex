%!TEX root = ../template.tex
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% chapter5.tex
%% NOVA thesis document file
%%
%% Chapter with Results 
%% Use case study
%% Tests Realized
%% My part is in this part of the data
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Results}
\label{cha:Results}
This chapter will cover the results of the system.  It will start by explaining the used Methodology, followed by the presentation of the use case where this thesis is integrated.
Then the geolocation and power results are presented to the reader, concluding with the validation of the system, and a discussion of the obtained results.

\section{Methodology}
\label{sec:methodology}
%%%PAPER
%%%<Describe shortly HOW you did address the problem. List a few of key existing scientific/technical achievements/solutions/theories/surveys you will rely upon in addressing the problem.>
%%!!!!conlusion Currently, the work already done consists of connecting the end device to the Carelink~\cite{carelink} platform, passing through a server that can perform the hierarchical localization. future work Furthermore, this tests will consist in gathering information from different points at different speeds as well stationary, to evaluate the performance of each technology against each other, a polygon will be created in both scenarios, later these tests are going to be conducted with real patients.!!!!!!


To respond to the previous problem identified by the research question, the presented work explains the development of an Adaptive Geolocation Solver model, that is capable to autonomously decide the best location method. This choice will be based on different variables, such as remaining battery and availability of communication technologies. The availability can be analyzed through advanced sensing of the surrounding radio environments. Besides this, the model should be aware of the environment in which it is working, the environment consists in the working place of the device, that can be either indoor or outdoor, besides this can be rural or urban, being the impact in what is used, dependent in what environment the device is currently working, and with all of this information in mind create a profile-based decision system.

For this to happen several tests will be conducted into two different scenarios, urban and rural. It is required tests for geolocation technologies both GPS, GPS-free, and assisted location, as well as communication methods, LoRa, NB-IoT, or others to evaluate power consumption and geolocation accuracy.

Furthermore, these tests will consist in gathering information from different location points, at different speeds as well as stationary, to evaluate the performance of different technologies against each other, using a geo-fencing polygon, that is defined by the career in the Carelink platform. At a later stage, these tests are going to be conducted with real patients.

% section methodology(end)


\subsection{Material}
\label{subsec:material}
In order to conduct the results of this work, it was selected $5$  FiPy devices, used in the belt  box format. That were used by the participants. 
The other material needed was a LoRa Gateway to ensure the coverage of LoRa signal, and a laptop to analyse the data.



\subsection{Participants}
\label{subsec:Participants}
The participants in this experiment were $n$, later in this chapter will describe two different environments. The participant for the first environment is male 24 and does not have dementia. In the second environment, the first tests were conducted by two participants both male one with 24 other with 60 when these tests were concluded, the final ones were conducted with $n$ persons with dementia, $n$ male $n$ female with ages from $n$ to $n$.

\subsection{Procedure}
\label{subsec:Procedure}
The adopted procedure for this work, during the development phase, was used a FiPy and first, each location method was tested individually, and then each communication later this was all combined. The real-world test phase was given to each participant to use during the day.

\section{Use Case}
\label{sec:Use_case}
\subsection{CARELINK} % (fold)
\label{sec:Use_case_CARELINK}
The CARELINK-AAL/0001/2016 - Living with Dementia , is an European project, target to people with a dementia that is a subgroup of the Alzheimer neurological disease.
Causing people with this condition to usually forget were they are , leading to wandering behaviours, that can put the lives of them in dangerous.

The purpose of this project is to develop a solution for such people, the solution is based on wearable device and a platform, the wearable device communicates with platform through several types of communication methods , and in the platform there is several services, being one of the services the tracking service. 

This thesis is integrated in the geolocation solver part that is going to be one of the blocks, passing information for the above mentioned tracking service, for the results of this work  the steps described bellow were taken.
% subsection Work Scenario (end)
\newpage


\section{Geolocation Results}
\label{sec:Geolocation_Results}
 To get the results for geolocation. Tests were conducted for geolocation technologies both GNSS, GNSS-free, as well as assisted location. These tests consisted of gathering information from different location points, at different speeds, as well as stationary, to discover the geolocation accuracy of such methods. 

\subsection{Laboratory Scenario}
\label{subsec:laboratory}
The first scenario described for this chapter is the Laboratory scenario. This is where all of the test phases occurred and is situated in the university campus of faculty of science from the new university of Lisbon.

\subsubsection{BLE}
\label{subsubsec:Geo_BLE}
The first  Geolocation method in the test is BLE Beacons. For this experiment was used two FiPy, one in the belt box enclosure other without enclosure. The antennas used were the internal antennas. 

The test consisted of one fixed FiPy acting as BLE Beacon, and another one mobile that was simulating the patient. The test was conducted indoor. Because the main usage for the Beacons will be indoor, although they can work outside.

In the Beacon side was created an advertisement for the beacon simply called $Pybeacon$, and a service called $GPS-Bluetooth-B1$  where the following data is presents $BLE->coordinates$ then exits variable called $GPS$ where the actual coordinates can be set by the user.

In the device side there is a scan for Bluetooth advertisers, if one match the $Pybeacon$ the device reads the values from the service, getting the data from the Beacon. This can also be done for managing the accompanied flag, that was presented in~\ref{tab:Profiles}.

The location accuracy is the one defined by the user, so it is going to be the best possible, the communication distance using both internal antennas were 2 m with obstacles, and 5m with a line of sight this value can increase to around 10 m with the use of an external antenna e the beacon side. The time used to retrieve the location is approximately 2s, and the BLE cannot be used to transmit the full Status message.
%\begin{figure}[htbp]
%  \centering

%    {\includegraphics[width=0.6\linewidth]{Chapters/Figures/bleradar.jpg}}%

 % \caption{BLE Results}
  %\label{fig:BLE_radar}
%\end{figure}


\begin{table}[htbp]
\centering
\begin{tabular}{@{}ccccc@{}}
\toprule
 & Max accuracy & Min Accurracy & Communication &    Time   \\ \midrule
\begin{tabular}[c]{@{}c@{}}BLE \\ Indoor\end{tabular} & 1 m & 10 m & No & 2 s\\ \bottomrule
\end{tabular}
\caption{BLE Results}
\label{tab:BLE_Res}
\end{table}

\subsubsection{GNSS}
\label{subsubsec:Geo_GNSS}
During the test phase in the laboratory scenario, the results obtained for the GNSS were done using one FiPy, and the respective pytrack shield. The Pytrack~\cite{PytrackSpecs} shield has a Quectel GNSS L76-L~\cite{quectel,quectelspecs}, this receiver module supports Multi-GNSS including GPS, GLONASS, Galileo and QZSS systems. The antenna used for the GNSS system was the one from the shield and not an external one due the design dimension constrains.

The test consisted first try to get an indoor position, which has expected failed. The test was then conducted outdoor. Already outdoor using LoRa as communication method, and at stationary speeds, the results obtained are expressed in the next figure~\ref{fig:GNSS_points}.

\begin{figure}[htbp]
  \centering

    {\includegraphics[width=0.7\linewidth]{Chapters/Figures/ttnmappergps.JPG}}%

  \caption{GNSS }
  \label{fig:GNSS_points}
\end{figure}

The next test consisted of getting  GNSS Location while walking, considering the walking speed of 5km/h, to simulate a tracking situation.  The TTFF (Time to first fix) announced is between 1 to 35 seconds, the one from the tests is more close to 2 minutes from a cold a start. The result using the device in a clear day and waiting for 5 minutes to fix position and then start walking are good but often during 40 minutes walk the device misses some points, some points return the location empty, this can be due to the fact the GNSS has 33 channels for tracking and 99 for the acquisition of the location. The problem verified with the requisitions of the location can be solved by using an external antenna. (se calhar por a aqui pontos estacionarios e n√£o tracking ficar para baixo)\newline
%\begin{figure}[htbp]
%  \centering

%    {\includegraphics[width=0.5\linewidth]{Chapters/Figures/gnssradar.JPG}}%

%  \caption{GNSS}
%  \label{fig:GNSS_radar}
%\end{figure}

\begin{table}[htbp]
\centering
\begin{tabular}{@{}ccccc@{}}
\toprule
 & Max accuracy & Min Accurracy & Communication &    Time   \\ \midrule
\begin{tabular}[c]{@{}c@{}}GNSS \\ Outdoor\end{tabular} & 5 m & 10 m & No & X s\\ \bottomrule
\end{tabular}
\caption{GNSS Results}
\label{tab:GNSS_Res}
\end{table}
The location accuracy is from ($<2,5 to 11$) 5 m to 10 m  .The time used to retrieve the location is approximately $x$ sec, and the GNSS cannot be used to transmit the full Status message.The next figure~\ref{fig:GNSS_radar} represents the resume of this geolocation technique.

%##########################################
\subsubsection{WiFi}
\label{subsubsec:Geo_WiFi}

The following Geolocation method in the test is the WiFi assisted location. For this experiment was used the same FiPy as above, in the belt box enclosure. The WiFi antenna used was the internal one. For the software was used the Geolocation API from Google.

The test consisted of one FiPy mobile that was simulating the patient. The test was conducted indoor. Because it was first tested with WiFi has a communication method therefore the maximum coverage of the WiFi Ap only permitted indoor usage and a bit outdoor.

\begin{figure}[htbp]
  \centering

    {\includegraphics[width=0.6\linewidth]{Chapters/Figures/wifilab.png}}%

  \caption{WiFi lab}
  \label{fig:WiFi_geo}
\end{figure}
In the device side, there is a scan for WiFi APs,  the device reads the values from APs  (access points or routers), these values consist in SSID( service set identifier) which is the WiFi name of the network),
BSSID( basic service set identifier) that is the  MAC address of the AP, RSSI (received signal strength indication) the power present in a received radio signal, there are others fields advertised such as the network channel or security, but they are all discarded since they are not useful in this situation.
After getting this info a JSON is generated in the device, to construct a request for the google API.
The Google API then returns the approximate location as its possible to observe in the figure~\ref{fig:WiFi_geo}.\newline

%\begin{figure}[htbp]
%  \centering

%    {\includegraphics[width=0.5\linewidth]{Chapters/Figures/wifiradar.JPG}}%

%  \caption{WiFi}
%  \label{fig:WiFi_radar}
%\end{figure}
\begin{table}[htbp]
\centering
\begin{tabular}{@{}ccccc@{}}
\toprule
 & Max accuracy & Min Accurracy & Communication &    Time   \\ \midrule
\begin{tabular}[c]{@{}c@{}}WiFi \\ Indoor\end{tabular} & 15 m & 100 m & Yes & X s\\ \bottomrule
\end{tabular}
\caption{WiFi Results}
\label{tab:WIF_Res}
\end{table}

For this test the JSON field $considerIp$ was set to false, otherwise, Google takes the IP of the connection to identify the position, which later will not be useful when WiFi is not used as the communication technology. By doing this, is necessary to handle the errors that exist when there is no WiFi APs, or Google databases has no position information about the WiFi APs, previous sent.

The returned location accuracy is from  15 m to 100 m  being. The time used to retrieve the location is approximately $x$ sec, and the WiFi can be used to transmit the full Status message. The previous figure~\ref{fig:WiFi_radar} represents the resume of this assisted geolocation technique.

%##########################################
\subsubsection{LoRa}
\label{subsubsec:Geo_LoRa}
The last Geolocation method in the test was LoRa for GNNS-free location. For this experiment was used the same FiPy as above. And for the first experiment was used three other FiPy acting as gateways. The LoRa antenna used was an external one (SMA Tilt Swivel 1/2 Wave Whip Dipole ). For the software was used the LoRa Cloud (formerly Collos) API from Semtech, and the TTN network server.

The first test consisted in using one FiPy mobile that was simulating the patient, And three others acting as gateways, for the gateways was used the LoRaWAN Nano-Gateway example from pycom, the only problem encountered was with the internet from the campus was blocking the UDP packets, so the gateway was not able to sync with NTP servers and was not capable to forward the messages, this problem was easily solved by using a smartphone as WiFi hot-spot. The test was conducted indoor, with the gateways separated from each other in a triangle shape. This test failed to obtain location due to the fact the gateway were closer than the maximum accuracy for this method. 
\begin{figure}[htbp]
  \centering
  
    {\includegraphics[width=0.5\linewidth]{Chapters/Figures/123.jpg}}%
 
  \caption{Lora 4 Gateways Location}
  \label{fig:Lora_4GWs}
\end{figure}

The second test consisted of the same board, but now the test was conducted outdoor. For the Gateway were used three although a fourth one was also in range by using the external antenna. The figure~\ref{fig:Lora_4GWs}, describe the test scenario and the three used Gateways can be seen in the next figure~\ref{fig:LoRa_GWs}, the right one is a raspberry pi 3 with a dragino hat, on the roof of building 230 meters from the middle one, that is LoRix One at the time of the test was inside of the Uninova CTS building, and the last one 80m  was also indoor in the Electrical Engineering department and was an ESP based Gateway. The other Gateway was located in Lisbon 8km way, and it is also a LoRix one.

\begin{figure}[htbp]
  \centering

    {\includegraphics[width=0.6\linewidth]{Chapters/Figures/ttn3gws.JPG}}%
   %{\includegraphics[width=\linewidth]{Chapters/Figures/ttngws.JPG}}%TTN Full
  \caption{LoRa GWs }
  \label{fig:LoRa_GWs}
\end{figure}

In device side was sent a small 1 byte payload using spreading factor 7, bandwidth 125 kHz, the first channels in 868.1 MHz and 868.3MHZ, the coding rate at 4/5 and the LoRa class as C. Using other specifications could result in other results, but due to the fact there were 2 single-channel gateways, this was the best specification to ensure all of them could listen to the message.
In the gateway side was simple a packet forwarded to the TTN server. In the TTN server was an Integrations with the LoRacloud API. Using the LoRa Metadata a location was then returned, as it is possible to observe in the next figure~\ref{fig:LoRa_geo_lab}.
\begin{figure}[htbp]
  \centering

    {\includegraphics[width=0.6\linewidth]{Chapters/Figures/loralab.JPG}}%

  \caption{LoRa lab}
  \label{fig:LoRa_geo_lab}
  \end{figure}
  
The returned location accuracy is from  20 m to 200 m. The time used to retrieve the location is approximately $x$ sec, and LoRa can be used to transmit the Status message, although is not the full status message, it is only the full values from the Status message, this one is later constructed in the TTN Network server. The next figure~\ref{fig:LoRa_radar} represents the resume of this GNNS-Free geolocation technique.

%\begin{figure}[htbp]
%  \centering

%    {\includegraphics[width=0.5\linewidth]{Chapters/Figures/loraradar.JPG}}%

%  \caption{LoRa Results}
%%  \label{fig:LoRa_radar}
%\end{figure}


\begin{table}[htbp]
\centering
\begin{tabular}{@{}ccccc@{}}
\toprule
 & Max accuracy & Min Accurracy & Communication &    Time   \\ \midrule
\begin{tabular}[c]{@{}c@{}}LoRa \\ Outdoor\end{tabular} & 20 m & 200 m & Yes & X s\\ \bottomrule
\end{tabular}
\caption{LoRa Results}
\label{tab:LoRa_Res}
\end{table}

%\subsubsection{Other GeoLocation}
%\label{subsubsec:Other_Geo}
%\paragraph{NB-IoT}
%\paragraph{SigFox}











%################### REAL WORLD ##################
\newpage
\subsection{Real World Scenario}
\label{subsec:real_world}
The second scenario described for this chapter is the Real World scenario. This scenario was separated in two test phases, the first one intended to test the results from the lab but in the real world, which took place in Lisbon and in Alenquer (40 km away from Lisbon) to simulate booth urban and rural environments. The second test phase was held in Switzerland where the first stage of the solution, called hierarchical,(where the decision is made using the approximate accuracy of each geolocation method), performed trials with real people with dementia. 
%##########################################

\subsubsection{GNSS}
\label{subsubsec:GNSS}

The GNSS test in this scenario used the same material has above in~\ref{subsubsec:Geo_GNSS}. The communication method used in this case was NB-IoT. And test consisted of gathering GNSS Location during walking, the average speed was 5km/h, to test a real tracking situation. GNSS took about two minutes to acquire a position after a cold start.
The result of using the device in a clear day, after waiting for around 5 minutes to fix position, and then start walking are possible to observe in the next figure~\ref{fig:GNSS_Results}, on the left side~\ref{fig:GPS_Path} is the registered GNSS path, and on the right is the real path~\ref{fig:GPS_Real}.  The walk last for 50 minutes with a 4.3 km distance(about 100 location points), in a rural environment non-stop, so none of the locations points is from stationary locations. Comparing both figures is possible to observe that some points are missing, this happens during the reacquisition of the location since the sample time was 30 seconds. The problem verified with the requisitions of the location can be solved by using an external more powerful antenna.
\begin{figure}[htbp]
  \centering
  \subcaptionbox{GNSS path \label{fig:GPS_Path}}%
    {\includegraphics[width=0.5\linewidth]{Chapters/Figures/GPS.JPG}}%
  \subcaptionbox{GNSS Real path\label{fig:GPS_Real}}%
    {\includegraphics[width=0.5\linewidth]{Chapters/Figures/GPSREAL.JPG}}%
  \caption{GNSS Results}
  \label{fig:GNSS_Results}
\end{figure}

The next test consisted of defined a safe location area. Then cross to unsafe zone and acquire GNSS location. This location was done outdoor, at stationary speed. The device sends the location to the model as it is possible to observe in the first figure~\ref{fig:gpsnodered}, the model send the info to the Carelink platform, which raises an SMS alert described in the middle figure~\ref{fig:sms}. Where there is a link to see the alert, as well as the position of the patient shown in the figure~\ref{fig:web_Alert}. The combination of these three figures~\ref{fig:Unsafe Zone Alert} is the workflow behind an Unsafe zone Alert, here described working with GNSS location.\newline\newline

\begin{figure}[htbp]
  \centering
  \subcaptionbox{GPS Node Red \label{fig:gpsnodered}}%
    {\includegraphics[height=8cm,width=0.3\linewidth]{Chapters/Figures/gpsnodered.jpg}}%
  \subcaptionbox{SMS Alert\label{fig:sms}}%
    {\includegraphics[height=8cm,width=0.3\linewidth]{Chapters/Figures/smsalert.jpg}}%
    \subcaptionbox{Web Alert\label{fig:web_Alert}}%
    {\includegraphics[height=8cm,width=0.3\linewidth]{Chapters/Figures/webalert.jpg}}%
  \caption{Unsafe Zone Alert }
  \label{fig:Unsafe Zone Alert}
\end{figure}

The location accuracy is from ($<2,5 to 11$) 5 m to 20 m. The time used to retrieve the location is approximately $x$ sec, and the GNSS cannot be used to transmit the full Status message.

%###########################################
\subsubsection{WiFi}
\label{subsubsec:WiFi}
For the WiFi assisted location test was used the same material as above. The test had the same objective, that was simulating a patient walking. The test was conducted outdoor. And it is different from the previous scenario, because the communication used now was NB-IoT, allowing more mobility and a bigger range for the walking.

The test consisted in using the WiFi passive scanning principle, in order to discover WiFi access points, using this information to do assisted Location during walking, the average speed was 5km/h. 

The result of using the device in an urban route is possible to observe in the next figure~\ref{fig:WiFi_Results}, on the left side~\ref{fig:wifi} is the registered GNSS path, and on the right is the real path~\ref{fig:wifi_Real}.  The walk lasts for 40 minutes with a 2.8 km distance (about 80 location points), in an urban environment. Comparing both figures is possible to observe that in the figure from the right, at bottom exist a residential area close to the green area, that was no problem for the WiFi assisted location, but close to the other green area exist a sports hall with a WiFi network and school with no WiFi, so this method was inaccurate. The optimal scenario for this assisted location will be urban outdoor, where it can achieve accuracies close to GNSS.

\begin{figure}[htbp]
  \centering
  \subcaptionbox{WiFi path \label{fig:wifi}}%
    {\includegraphics[width=0.5\linewidth]{Chapters/Figures/wifi.JPG}}%
  \subcaptionbox{WiFi Real path\label{fig:wifi_Real}}%
    {\includegraphics[width=0.5\linewidth]{Chapters/Figures/wifireal.JPG}}%
  \caption{WiFi }
  \label{fig:WiFi_Results}
\end{figure}

For this method to work, is used the same principle as above wherein the device side there is a scan for WiFi AP's.  The device reads the  SSID,BSSID, RSSI.
After this generates an array and sends to the model. In the model, this array is converted to a JSON to construct a request for the three used API's (Google, Here, OpenCellID).
The API¬¥s then returns the approximate location in different formats, these formats are standardized, and the most accurate one is chosen for sending to the platform,  as it is possible to observe in the figure~\ref{fig:wifi}.
The returned location accuracy is from  15m to 200m  being. The time used to retrieve the location is approximately $x$ sec. The median over 80 points was $x39$ meters with a standard deviation of $x21.63$ meters. 

%#################################################################
\subsubsection{LoRa}
\label{subsubsec:LoRa}

The  LoRa Geolocation method was the last one tested. For this experiment was used the same FiPy as above. The LoRa antenna in use was an external one ( molex ISM 105262, omnidirectional with 0.4 dBi Peak Gain at 868MHZ). In terms of software was used the LoRa Cloud (formerly Collos) API from Semtech, the TTN network server, and Cayenne~\cite{cayenne}.

The objective of the test consisted of using the Metadata present in the LoRa messages, to get an assisted location for one FiPy mobile, that was simulating the real patient. The test was a walk with a duration of 30 minutes, in an outdoor scenario, for a distance of 2km at an average speed of 5km/h. The result of using the device in an urban route is possible to observe in the next figure~\ref{fig:lora_geo_realpath}.

\begin{figure}[htbp]
  \centering
  
    {\includegraphics[width=0.8\linewidth]{Chapters/Figures/lorageorespercurso101019.PNG}}%
 
  \caption{LoRa Real path}
  \label{fig:lora_geo_realpath}
\end{figure}

The results of this test were dependent on the number of gateways in reach of the device, in order to perform the multilateration a minimum of three gateways were needed. So the location of the test was chosen taking on considerations this constrains, and one of the best places in Lisbon at the time of the test was the one from figure~\ref{fig:lora_geo_realpath}. For the Gateway were used three community gateways with the objective to simulate a real usage scenario. From the data in figure~\ref{fig:lora_geo_GWs}, it can be seen that all of them covered the test area. 

\begin{figure}[htbp]
  \centering
  
    {\includegraphics[width=0.8\linewidth]{Chapters/Figures/lorageoresttnmapperGWS.PNG}}%
 
  \caption{LoRa Gateways}
  \label{fig:lora_geo_GWs}
\end{figure}

The test was also conducted in an area central to all of the three gateways, the figure~\ref{fig:GW1LOS} shows the first one at a distance of 2.67 km, the second at figure~\ref{fig:GW2LOS} is at 2.85 km and the last in figure~\ref{fig:GW3LOS} was at 2.66 km. From this figures is possible to observe that none of the gateways had a direct line of sight, although all of them were placed outdoor and possible on top of the buildings, so it is possible they had a line of sight once the figures only represent terrain elevation and not building elevation, the first one is registered at 175m the second at 100m and the third is unknown this info is from the TTN~\cite{TTN} and it is set by the owner of the gateways.

\begin{figure}[htbp]
  \centering
       {\includegraphics[width=0.7\linewidth]{Chapters/Figures/GW1.JPG}}%
   \caption{GW1 Distance and Line of Sight}
  \label{fig:GW1LOS}
\end{figure}

From the previous information is possible to expect, more points closer to the first gateway, since is the closer one with the better chances for a line of sight. 
\begin{figure}[htbp]
  \centering
      {\includegraphics[width=0.7\linewidth]{Chapters/Figures/GW2.JPG}}%
  \caption{GW2 Distance and Line of Sight}
    \label{fig:GW2LOS}
\end{figure}

The third gateway should be the one with more difficulties to receive the packets. In device-side was sent the full payload using spreading factor 7, bandwidth 125 kHz, the first channels in 868.1 MHz, the coding rate at 4/5 and the LoRa class as C and Transmission power of 14 dBm. Using other specifications could result in other results, or using the adaptive data rate to change the Spreading factor could result in better reception from the gateways, but these specifications are the most common one from low-end gateways, and this test tried to replicate the normal usage from a patient anywhere.

\begin{figure}[htbp]
  \centering
 {\includegraphics[width=0.7\linewidth]{Chapters/Figures/GW3.JPG}}%
   \caption{GW3 Distance and Line of Sight}
  \label{fig:GW3LOS}
\end{figure}

In the gateway side was simple a packet forwarded to the TTN server, the gateway added the Metadata to the message. In the TTN server was an Integrations with the LoRacloud API.
  
  
%################# V1 RSSI
The first result for the location is represented in the next figure~\ref{fig:lora_geo_res_rssiv1}, here is shown a map of all the locations points, this map is part of the Cayenne dashboard. For this was used the LoRacloud V1 single frame RSSI location.  which Calculates a location for a device according to RSSI data, received by the gateway. The property "Location" of the gateway is not required. However, the property can be used if the gateway and it is antenna location is not provisioned in the system. This means that the location will be more accurate if the gateways have GNSS capabilities, or the location of them are accurately defined.

\begin{figure}[htbp]
  \centering
  
    {\includegraphics[width=0.8\linewidth]{Chapters/Figures/lorageores21-2.PNG}}%
 
  \caption{LoRa Location RSSI All points}
  \label{fig:lora_geo_res_rssiv1}
\end{figure}

In the figure~\ref{fig:lora_geo_res_rssiv1}, is possible to observe the location points float within the Gateway 1 and 2, but are more close to the first this is caused by the fact the first one was receiving the messages with better RSSI, the factors for this can be a higher gain antenna on the receiver, or better line of sight or multipath for the test location. In The next picture~\ref{fig:lora_geo_res_RSSIV1_Zoom}, is showed a zoom of the test location, therefore removing all the others outliers, and it is possible to infer that some of the points are close to the real path. The announced accuracy for this method previous stated in~\ref{fig:lora_Geo_compare} was 1000 to 2000 meters, and the observed was around 30 to 3000 meters.

\begin{figure}[htbp]
  \centering
  
    {\includegraphics[width=0.8\linewidth]{Chapters/Figures/lorageores21-1.PNG}}%
 
  \caption{LoRa Location RSSI Zoom}
  \label{fig:lora_geo_res_RSSIV1_Zoom}
\end{figure}





%######################### V2 TDOA
For the second result was used the LoRa cloud V2 TDOA, which solves the location for a device according to RSSI Metadata combined with high-resolution time of arrival (TOA) Metadata. The time of arrival is measured in nano-seconds and is only supported by LoRa gateways with the necessary high-resolution time-stamping features the ones with GNSS. The figure~\ref{fig:lora_geo_resTDOA1}, shows all of the points.
\begin{figure}[htbp]
  \centering
  
    {\includegraphics[width=0.8\linewidth]{Chapters/Figures/lorageores25-2.jpg}}%
 
  \caption{LoRa Location TDoA all pooints}
  \label{fig:lora_geo_resTDOA1}
\end{figure}

Concerning the previous method is possible to observe fewer outliers, and also fewer points when the zoom is done in the figure~\ref{fig:lora_geo_resTDOAZOM}. This is possibly caused to the restrictions of having a high-resolution time-stamping, and possible only gateway one had it or at least had the better one. The announced accuracy for this method was 20 to 200 meters, and if the gateway location point is considered an outlier the result got close, from 30m to 350m. Could have been improved maybe with other gateways, but comparing figure~\ref{fig:lora_geo_resTDOA1} with figure~\ref{fig:lora_geo_res_rssiv1} is clearly an improvement 

\begin{figure}[htbp]
  \centering
  
    {\includegraphics[width=0.8\linewidth]{Chapters/Figures/lorageores25-1.PNG}}%
 
  \caption{LoRa Location TDoA Zoom}
  \label{fig:lora_geo_resTDOAZOM}
\end{figure}






%####################V3
The last results were from LoRa cloud V3 Multiframe, this calculates a location for a device according to the received signal strength indicator (RSSI) data captured from multiple LoRa frames (uplinks). Using a sequence of single frames (consisting of multiple uplink objects), that are typically received by the gateways within a short time frame. These frames are assumed to be transmitted by the device in the same location. The result is a single location estimate. Using the sequence of radio frames for a single estimate allows for estimating the device‚Äôs location with higher accuracy than the single-frame alternative. The multi-frame technique also combines all the available data (RSSI, TDOA, SNR) into a single calculation, resulting in a location estimate that is generally more accurate than averaging multiple locations calculated from several single frames. This technique will work better with higher sample rates from the device, or with a stationary location. The following figure~\ref{fig:lora_geo_multiframe}, represents the location points for this method.Comparing to the previous method the results were almost the same due to the fact the location was retrieved during walking and not stationary, and the sample time of 30 seconds was maybe too high for getting multiple frames in the same, or at least in a close location.
\begin{figure}[htbp]
  \centering
  
    {\includegraphics[width=0.8\linewidth]{Chapters/Figures/lorageores27-3.PNG}}%
 
  \caption{LoRa Location RSSI All points}
  \label{fig:lora_geo_multiframe}
\end{figure}


The returned location accuracy for the 3 methods was from  30 m to 3000 m. The time used to retrieve the location is approximately $x$ sec, and LoRa was used to transmit the Status message, although is not the full status message, it is only the full values from the Status message, this one is later constructed in the TTN Network server.
In short, LoRa has the worst accuracy from all of the methods, but a the same time is better in the battery usage. The previous results are thus conditioned by the fact the Gateway one was better than the others. This location method has the possibility of creation of an ad hoc network, insuring this way better location results. The optimal scenario for this assisted location will be urban or rural outdoor.
%#######################all###################

\subsubsection{Geolocation Results Comparison}
\label{subsubsec:geocompare}


In this subsection, the objective is to clarify and compare the different geolocation techniques from both scenarios. The firs geolocation tested was BLE, the optimal scenario for this will be indoor, short-range location, for example, to know if a person is in some room, or in building to know in which floor the person is at. The second one in the study was the GNSS. This is the classic for solving location problems, and the best fit would be outdoor in a rural environment, but it will also work in an urban environment. The third one is WiFi and the best scenario for this assisted location will be urban outdoor, where the accuracy for the results can be close to GNSS. The last one is the analyse of the LoRa Metadata where the optimal scenario for this assisted location will be urban or rural outdoor, but can also work Indoor, and is the best fit essentially when there is none of the others or the battery is to low.

%##################end Real world################


%############### Start power management ########

\newpage
\section{Power Management Results}
\label{subsec:power_management}

For the purpose of getting the results for power consumption.   Tests were conducted for the different communication methods and location method. These tests consisted of logging information from the device, with the aim to discover the battery duration, current and power, to do more efficient power management. From the device manufacturer is possible to observe the next figure~\ref{fig:PowerTableAll}, where some values are already provided. All of the tests were conducted in the same fix place, at stationary speeds, with the same 2 FiPy and two batteries with 800mAh, the results are the average from 4 tests.

\begin{figure}[htbp]
  \centering
  
    {\includegraphics[width=\linewidth]{Chapters/Figures/power1.PNG}}%
 
  \caption{Power Table Fipy~\cite{Microcontroller2017}}
  \label{fig:PowerTableAll}
\end{figure}


\subsection{LoRa}
\label{subsec:LoRa}

The first communication method in study was LoRa. To prepare this test was used the two FiPys and after letting the batteries charge over 3 hours with a 2.1 A charger connect to devices. The first test was started, using only communication, the Fipy was combined with a pysense (without GNSS and Accelerometer)  shield, and the initial battery was around 4.1 V and the end battery has expected was 3.3 V. The next test was using the communication but reading one accelerometer sensor, and getting the gps location, the only difference here was the use of pytrack instead of pysense. The result for the battery duration is lower has expected, for the last test was introduced also the WiFi scan for nearby Access points. The data for all of the tests is at the next table~\ref{tab:LoRa_Power}. 

\begin{table}[htbp]
\centering
\begin{tabular}{@{}cclclcl@{}}
\toprule
\multicolumn{1}{l}{} & \multicolumn{2}{c}{\begin{tabular}[c]{@{}c@{}}Communication\\ Only\end{tabular}} & \multicolumn{2}{c}{\begin{tabular}[c]{@{}c@{}}Communication\\ GNSS, Sensor\end{tabular}} & \multicolumn{2}{l}{\begin{tabular}[c]{@{}l@{}}Communication\\ GNSS, Sensor,\\ Scan WiFi\end{tabular}} \\ \midrule
\begin{tabular}[c]{@{}c@{}}Battery \\ Duration\end{tabular} & \multicolumn{2}{c}{??} & \multicolumn{2}{c}{??} & \multicolumn{2}{c}{??} \\
Current & \multicolumn{2}{c}{??} & \multicolumn{2}{c}{??} & \multicolumn{2}{c}{??} \\
Power & \multicolumn{2}{c}{??} & \multicolumn{2}{c}{??} & \multicolumn{2}{c}{??} \\ \bottomrule
\end{tabular}
\caption{LoRa Power}
\label{tab:LoRa_Power}
\end{table}

The following figure~\ref{fig:LoRaPowerTable}, represent current results from the manufacturer, which gives the baseline for the above mentioned tests. LoRa has different spreading factors the configurations used in this test was the same that was previous used in the LoRa section of~\nameref{sec:Geolocation_Results}, that were spreading factor 7, bandwidth 125 kHz, TX power 14 dBm, sample time 30 seconds, and message size of $x$ bytes.

\begin{figure}[htbp]
  \centering
  
    {\includegraphics[width=\linewidth]{Chapters/Figures/Lora2.PNG}}%
 
  \caption{LoRa Power Table~\cite{Microcontroller2017}}
  \label{fig:LoRaPowerTable}
\end{figure}

\subsection{NB-IoT}
\label{subsec:NB} 

The next communication method used for this test was, NB-IoT. The procedure was the same as above starting by using only communication and then increasing the battery usage with GNSS and accelerometer, ending with all of this plus the scan of WiFi APs. The NB-IoT is expected to have poor performance compared to LoRa, because of the message size of $x$ bytes which is $x$ times higher than LoRa. The result for this method are described in the following table~\ref{tab:NB_Power}

\begin{table}[htbp]
\centering
\begin{tabular}{@{}cclclcl@{}}
\toprule
\multicolumn{1}{l}{} & \multicolumn{2}{c}{\begin{tabular}[c]{@{}c@{}}Communication\\ Only\end{tabular}} & \multicolumn{2}{c}{\begin{tabular}[c]{@{}c@{}}Communication\\ GNSS, Sensor\end{tabular}} & \multicolumn{2}{l}{\begin{tabular}[c]{@{}l@{}}Communication\\ GNSS, Sensor,\\ Scan WiFi\end{tabular}} \\ \midrule
\begin{tabular}[c]{@{}c@{}}Battery \\ Duration\end{tabular} & \multicolumn{2}{c}{??} & \multicolumn{2}{c}{??} & \multicolumn{2}{c}{??} \\
Current & \multicolumn{2}{c}{??} & \multicolumn{2}{c}{??} & \multicolumn{2}{c}{??} \\
Power & \multicolumn{2}{c}{??} & \multicolumn{2}{c}{??} & \multicolumn{2}{c}{??} \\ \bottomrule
\end{tabular}
\caption{NB-IoTPower}
\label{tab:NB_Power}
\end{table}



\subsection{WiFi}
\label{subsec:WiFi}

The last one used for this tests was WiFi, this method is expected to have the worst battery performance, but at the same time is the one with higher transfer speeds, meaning the airtime for the same data is lower, so in right circumstances could perform better than the previous two, this was the objective of the test, although WiFi could not be used as viable options due to the short-range, and the need for a password. The results for the same tests are expressed in the next table~\ref{tab:WiFi_Power}.
\newline
\begin{table}[htbp]
\centering
\begin{tabular}{@{}cclclcl@{}}
\toprule
\multicolumn{1}{l}{} & \multicolumn{2}{c}{\begin{tabular}[c]{@{}c@{}}Communication\\ Only\end{tabular}} & \multicolumn{2}{c}{\begin{tabular}[c]{@{}c@{}}Communication\\ GNSS, Sensor\end{tabular}} & \multicolumn{2}{l}{\begin{tabular}[c]{@{}l@{}}Communication\\ GNSS, Sensor,\\ Scan WiFi\end{tabular}} \\ \midrule
\begin{tabular}[c]{@{}c@{}}Battery \\ Duration\end{tabular} & \multicolumn{2}{c}{??} & \multicolumn{2}{c}{??} & \multicolumn{2}{c}{??} \\
Current & \multicolumn{2}{c}{??} & \multicolumn{2}{c}{??} & \multicolumn{2}{c}{??} \\
Power & \multicolumn{2}{c}{??} & \multicolumn{2}{c}{??} & \multicolumn{2}{c}{??} \\ \bottomrule
\end{tabular}
\caption{WiFi Power}
\label{tab:WiFi_Power}
\end{table}
\newline


\subsection{Comparison}
\label{subsec:Comparison}
To close this section, a comparison with different communications methods can be observed in the next table~\ref{tab:Battery Duration}. This table combines all of the data from the previous, making easier to compare the different methods always taking into consideration the conditions for the different tests. As expected LoRa had the best battery duration, followed by NB-IoT and WiFi had the worst battery duration. 
\newline

\begin{table}[htbp]
\centering
\begin{tabular}{@{}lcccc@{}}
\toprule
 & NB-IoT & LoRa & WiFi & SigFox \\ \midrule
1- Communication only & ?? & 12h & ?? & ?? \\
\begin{tabular}[c]{@{}l@{}}2- Communication \\ GPS, Sensor\end{tabular} & 4h 30m & 9h & ?? & ?? \\
\begin{tabular}[c]{@{}l@{}}3-Communication\\ GPS, Sensor, Scan WiFi\end{tabular} & 4h & 8h 30m & ?? & ?? \\ \bottomrule
\end{tabular}
\caption{Battery Duration}
\label{tab:Battery Duration}
\end{table}
%########################## End Power Management







%####################### Start Validation
\newpage
\section{Validation}
\label{sec:validation}

The firsts result for the model, obtained during the initial phase of tests, were a total of over 50000 received messages from 10/02/2020 until 10/03/2020. The difference of the received messages and the sent messages was less than 1\%. The system was able to support spikes of simultaneously received messages from different devices, and the tested version was able to process 1 message per 2 seconds. These first tests were conducted using 4 devices. These test phase was held in Switzerland where the first functional stage of the solution, called hierarchical,(where the decision is made using the approximate accuracy of each geolocation method), performed trials with real people with dementia in real life trials.  

In the next figure~\ref{fig:node_red_debug}, is possible to observe the output, of the system in a real life test situation, in this figure is represented the device "CP10" which was used by a person, and first is possible to observe that the message from the device contains the "wifiAPs" field, which was used to perform the assisted location, in this situation by the google API. This means that the system received a location empty from the GNSS and the used the "wifiAPs" field do perform the assisted location, and the replace the GNSS data with this information. With this picture is possible to prove that system was working.
\begin{figure}[htbp]
  \centering
    \scalebox{0.6}{
    {\includegraphics[width=0.5\linewidth]{Chapters/Figures/CP10swiss.png}}%
    }
  \caption{Model Debug Output}
  \label{fig:node_red_debug}
\end{figure}



\begin{figure}[htbp]
  \centering
    \scalebox{0.6}{
    {\includegraphics[width=\linewidth]{Chapters/Figures/opencell.png}}%
    }
  \caption{OpenCell ID}
  \label{fig:OpennCellID_chart}
\end{figure}




From the data  in the chart~\ref{fig:OpennCellID_chart}, referent to OpenCellID API, is possible to conclude that over 50000 calls were made, meaning that the system used much of the time the wifi data, and from the data of the same chart is possible to observe that the result of the location failed, that why it was important to have 3 APIs, has location sources.

To conclude the system was able to dynamically choose the best location, from the information received.

%################# Start Discussion

\section{Discussion}
\label{sec:Discussion}

One initial objective was to  determine what kind of impact had LPWAN enabled solutions in wearable devices, in particular those focused on people with dementia.\newline 
It was hypothesized that people dealing with dementia would benefit from LPWAN enabled solutions. Since they would help in perform the location of the person, while saving battery, reducing the overall cost, and complain with the technical constraints of wearable devices. Having also the possibility to dynamically choose, the best location available in that moment. \newline 
The result accuracy match those mentioned in previous studies of geolocation technologies and techniques, and that are represented in~\nameref{sec:related_work}.\newline 
There are several possible explanations for the results, since the used hardware, to the environmental conditions, for example if the tests were taken outdoor in an urban or rural place. \newline 
With this result, in the system  was possible to observe that with the change of communication, and the type of received message the system was capable of returning the same output, and perform the adaptive geolocation.\newline 
These results provide support for the hypothesis that LPWAN can be used for the locations o people with dementia while accounting for the constraints of wearable IoT devices.



!!!!!(Esta sec√ß√£o poder√° ser combinada na conclus√£o) !!!!

%################# End Discussion
%################# End Results